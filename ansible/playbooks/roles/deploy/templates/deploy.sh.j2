#!/usr/bin/env bash

set -o errexit

export KUBECONFIG="$HOME/.kube/config"

export IMAGE="{{ docker_image.split(":")[0] }}:$TAG"
export RELEASE_JOB_NAME="django-release-job-$TAG"

echo "Deploying image $IMAGE"

echo "Running migrations..."

# Create new release job
cat <<EOF > /tmp/django-release-job.yaml
{{ release_job }}
EOF

# Apply the modified YAML to create the new job
kubectl apply -f /tmp/django-release-job.yaml -n default

kubectl wait --for=condition=complete job/$RELEASE_JOB_NAME --timeout=60s

# Delete the job after it has completed
kubectl delete pod -l job-name=$RELEASE_JOB_NAME
kubectl delete job $RELEASE_JOB_NAME

echo "Starting deployment..."

kubectl set image deployment/django-app django=$IMAGE -n default

echo "Updating cron jobs..."

{% for cronjob in cronjobs %}
kubectl set image cronjob/{{ cronjob.name }} {{ cronjob.name }}=${IMAGE} -n default
{% endfor %}
