{% load i18n %}
{% if episode %}
    {% if is_playing %}
        {% translate "Current Time" as t_current_time %}
        {% translate "Time Remaining" as t_time_remaining %}
        {% translate "Play" as t_play %}
        {% translate "Pause" as t_pause %}
        {% translate "Close Player" as t_close_player %}
        {% translate "Skip Back 10 Seconds" as t_skip_back %}
        {% translate "Skip Forward 10 Seconds" as t_skip_forward %}
        {% translate "Decrease Playback Rate" as t_decrease_playback_rate %}
        {% translate "Increase Playback Rate" as t_increase_playback_rate %}
        {% translate "Playback Rate" as t_playback_rate %}
        {% translate "Reload Player" as t_reload_player %}
        {% with podcast=episode.podcast episode_url=episode.get_absolute_url media_url=episode.media_url %}
            <div x-data="
                {# fmt:off #}
            player(
                autoplay={{ start_player|yesno:'true,false' }},
                currentTime={{ current_time|default:0 }},
                csrfToken='{{ csrf_token }}',
                timeUpdateUrl='{% url 'episodes:player_time_update' %}',
            ){# fmt:on #}"
                @keydown.window="shortcuts"
                class="pt-12 sm:pt-0 md:pt-6">
                {{ episode.get_media_metadata|json_script:"player-metadata" }}
                <audio x-ref="audio"
                    preload="metadata"
                    src="{{ media_url }}"
                    @loadedmetadata="loaded"
                    @play="play"
                    @pause="pause"
                    @ended="ended"
                    @timeupdate="timeUpdate"
                    @waiting="buffering"
                    @stalled="buffering"
                    @suspend="buffering"
                    @error.prevent="error">
                    <source src="{{ media_url }}" type="{{ episode.media_type }}" />
                </audio>
                <div class="fixed bottom-0 z-10 w-full p-2 font-semibold text-white bg-black opacity-100 space-y-3 sm:space-y-0 transform ease-in-out duration-1000 translate-y-0 htmx-added:opacity-0 htmx-added:translate-y-24">
                    <div class="sm:hidden">
                        <a class="block text-center truncate w-84"
                            :class="isPlaying ? 'hover:text-blue-500' : 'animate-pulse text-gray-300'"
                            href="{{ episode_url }}"
                            hx-swap="innerHTML show:window:top"
                            title="{{ episode.cleaned_title }}">{{ episode.cleaned_title }}
                        </a>
                    </div>
                    <div class="flex items-center space-x-2">
                        {% include "includes/cover_image.html" with css_class="w-16 h-16 sm:h-20 sm:w-20 lg:h-24 lg:w-24" cover_url=podcast.cover_url alt=podcast.cleaned_title url=podcast.get_absolute_url hx_swap="innerHTML show:window:top" %}
                        <div class="flex flex-col w-full h-16 sm:h-20 lg:h-24 place-content-between">
                            <div class="hidden sm:flex justify-center items-center">
                                <a class="sm:max-w-xl lg:max-w-4xl xl:max-w-5xl truncate"
                                    :class="isPlaying ? 'hover:text-blue-500' : 'animate-pulse text-gray-300'"
                                    href="{{ episode_url }}"
                                    hx-swap="innerHTML show:window:top"
                                    title="{{ episode.cleaned_title }}">{{ episode.cleaned_title }}
                                </a>
                            </div>
                            <div class="flex items-center justify-center sm:justify-between">
                                {% with BUTTON_CSS="focus:outline-none hover:text-blue-500" INACTIVE_CSS="opacity-75 cursor-not-allowed pointer-events-none" %}

                                    <div class="hidden sm:block text-xs lg:text-sm"
                                        :class="isPlaying || 'animate-pulse text-gray-300'"
                                        x-text="counters.current"
                                        title="{{ t_current_time }}">
                                        00:00:00
                                    </div>
                                    <div class="flex items-center justify-center space-x-3">
                                        <button title="{{ t_pause }}"
                                            @click="togglePlayPause"
                                            x-show="!isPaused"
                                            class="{{ BUTTON_CSS }}"
                                            :disabled="!isLoaded"
                                            :class="isLoaded || 'text-gray-300 cursor-events-none'">
                                            {% icon "pause-circle" "regular" size="xl" title=t_pause %}
                                        </button>
                                        <button title="{{ t_play }}"
                                            @click="togglePlayPause"
                                            x-show="isPaused"
                                            class="{{ BUTTON_CSS }}"
                                            :class="isLoaded || 'text-gray-300 cursor-events-none'">
                                            {% icon "play-circle" "regular" size="xl" title=t_play %}
                                        </button>
                                        <button title="{{ t_close_player }}"
                                            accesskey="x"
                                            class="{{ BUTTON_CSS }}"
                                            hx-post="{% url "episodes:close_player" %}"
                                            hx-target="#audio-player"
                                            hx-swap="innerHTML"
                                            hx-disinherit="hx-indicator">
                                            {% icon "stop-circle" "regular" size="lg" title=t_close_player %}
                                        </button>
                                        <button title="{{ t_reload_player }}"
                                            class="{{ BUTTON_CSS }}"
                                            accesskey="r"
                                            @click="window.location.reload()">
                                            {% icon "arrows-rotate" size="lg" title=t_reload_player %}
                                        </button>

                                        <button title="{{ t_skip_back }}"
                                            @click="skipBack"
                                            :class="isPlaying || '{{ INACTIVE_CSS }}'"
                                            class="{{ BUTTON_CSS }} inline-block">
                                            {% icon "backward-step" "solid" size="lg" title=t_skip_back %}
                                        </button>
                                        <button title="{{ t_skip_forward }}"
                                            @click="skipForward"
                                            :class="isPlaying || '{{ INACTIVE_CSS }}'"
                                            class="{{ BUTTON_CSS }} inline-block">
                                            {% icon "forward-step" "solid" size="lg" title=t_skip_forward %}
                                        </button>
                                        <div class="flex items-center space-x-1">
                                            <button class="{{ BUTTON_CSS }}"
                                                :class="isPlaying || '{{ INACTIVE_CSS }}'"
                                                @click="decrementRate"
                                                title="{{ t_decrease_playback_rate }}">
                                                {% icon "minus" "solid" title=t_decrease_playback_rate %}
                                            </button>
                                            <div class="tracking-tight player--interactive text-xs lg:text-sm"
                                                title="{{ t_playback_rate }}"
                                                x-text="rate.toFixed(1)">
                                            </div>
                                            <button class="{{ BUTTON_CSS }}"
                                                :class="isPlaying || '{{ INACTIVE_CSS }}'"
                                                @click="incrementRate"
                                                title="{{ t_increase_playback_rate }}">
                                                {% icon "plus" "solid" title=t_increase_playback_rate %}
                                            </button>
                                        </div>
                                    </div>
                                    <div class="hidden sm:block text-xs lg:text-sm"
                                        :class="isPlaying || 'animate-pulse text-gray-300'"
                                        x-text="counters.total"
                                        title="{{ t_time_remaining }}">
                                        00:00:00
                                    </div>
                                {% endwith %}
                            </div>
                            <div class="flex text-xs justify-between md:text-sm pb-1 sm:hidden"
                                :class="isPlaying || 'animate-pulse text-gray-300'">
                                <span x-text="counters.current" title="{{ t_current_time }}">00:00:00</span>
                                <span x-text="counters.total" title="{{ t_time_remaining }}">00:00:00</span>
                            </div>
                            <div class="w-full h-3">
                                <input type="range"
                                    aria-label="Progress"
                                    class="flex items-center w-full h-2 mx-auto rounded-full focus:outline-none"
                                    x-ref="range"
                                    x-model="runtime"
                                    @change="skip"
                                    min="0"
                                    :max="duration"
                                    :disabled="!isPlaying"
                                    :class="isPlaying ? 'bg-gradient-to-r from-blue-900 to-blue-600 cursor-pointer': 'bg-gray-800 dark:bg-gray-600 cursor-not-allowed'">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endwith %}
    {% endif %}
    {% if request.htmx.target == "audio-player" %}
        {% include "episodes/includes/audio_controls.html" with hx_oob=True %}
        {% include "episodes/includes/history.html" with hx_oob=True %}
    {% endif %}
{% endif %}
