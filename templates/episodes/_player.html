{% load static %}
{% if is_playing %}
    {% with podcast=episode.podcast episode_url=episode.get_absolute_url %}
        <div x-data="player"
            @keydown.window="shortcuts">
            {{ episode.get_media_metadata|json_script:"player-metadata" }}
            <audio x-ref="audio"
                preload="metadata"
                :src="mediaSrc"
                @ended="ended"
                @error="error"
                @loadedmetadata="loaded"
                @pause="paused"
                @play="resumed"
                @timeupdate="timeUpdate"
                @loadstart="buffering"
                @waiting="buffering"
                @progress="buffering"
                @stalled="buffering"
                @suspend="buffering">
            </audio>
            <div class="fixed bottom-0 z-10 bg-black dark:bg-gray-800 text-white w-full p-1 font-semibold space-y-1 sm:space-y-0"
                x-ref="controls"
                x-show="mediaSrc"
                :class="{'player--active': isPlaying && !isError, 'player--inactive': !isPlaying || isError}">

                <div class="sm:hidden">
                    <a class="w-84 truncate block text-center player--title"
                        href="{{ episode_url }}"
                        hx-swap="outerHTML show:window:top"
                        title="{{ episode.cleaned_title }}">{{ episode.cleaned_title }}</a>
                    <div class="text-xs lg:text-sm text-center sm:hidden player--title">
                        <span x-text="counters.current"></span> /
                        <span x-text="counters.duration"></span>
                    </div>
                </div>

                <div class="flex items-center space-x-2 sm:space-x-0">

                    {% with cover_url=podcast.cover_url %}
                        <div class="w-20 lg:w-24">
                            {% include "_cover_image.html" with size=24 css_class="h-16 w-16 lg:h-20 lg:w-20" alt=podcast.cleaned_title url=podcast.get_absolute_url hx_swap="outerHTML show:window:top" %}
                        </div>
                    {% endwith %}

                    <div class="w-full flex flex-col place-content-between h-16 lg:h-20">

                        <div class="flex justify-between items-center">

                            <div class="flex items-center">
                                {% with BUTTON_CSS="focus:outline-none hover:text-blue-500 inline-block" ICON_CSS="h-8 w-8 lg:h-9 lg:w-9"  %}

                                    <button title="Pause"
                                        @click="togglePlayPause"
                                        x-show="!isPaused"
                                        class="{{ BUTTON_CSS }} mr-1 lg:mr-2"
                                        :disabled="!isLoaded"
                                        :class="{'text-gray-300 cursor-events-none': !isLoaded}">
                                        {% icon "pause" css_class=ICON_CSS %}
                                    </button>

                                    <button title="Play"
                                        @click="togglePlayPause"
                                        x-show="isPaused"
                                        class="{{ BUTTON_CSS }} mr-1 lg:mr-2"
                                        :class="{'text-gray-300 cursor-events-none': !isLoaded}">
                                        {% icon "play" css_class=ICON_CSS %}
                                    </button>

                                    <button title="Close Player"
                                        accesskey="x"
                                        class="{{ BUTTON_CSS }}"
                                        hx-post="{% url "episodes:close_player" %}"
                                        hx-target="#player"
                                        hx-swap="innerHTML">
                                        {% icon "stop" css_class=ICON_CSS %}
                                    </button>

                                    <button class="hidden"
                                        x-ref="complete"
                                        hx-post="{% url "episodes:player_complete" %}"
                                        hx-target="#player"
                                        hx-swap="innerHTML"></button>

                                {% endwith %}

                            </div>


                            <div class="hidden sm:block">
                                <div>
                                    <a class="truncate text-center block sm:w-80 md:w-96 lg:w-auto lg:max-w-xl xl:max-w-3xl player--title"
                                        href="{{ episode_url }}"
                                        hx-swap="outerHTML show:window:top"
                                        title="{{ episode.cleaned_title }}">{{ episode.cleaned_title }}</a>
                                </div>
                                <div class="text-xs lg:text-sm text-center player--title">
                                    <span x-text="counters.current"
                                        title="Current Time"></span> /
                                    <span x-text="counters.duration"
                                        title="Time Remaining"></span>
                                </div>
                            </div>

                            {% with BUTTON_CSS="focus:outline-none hover:text-blue-500" ICON_CSS="h-6 w-6 lg:h-7 lg:w-7" %}

                                <div class="flex items-center sm:hidden space-x-1">

                                    <button title="Skip back 10 seconds"
                                        @click="skipBack"
                                        class="{{ BUTTON_CSS }} player--interactive inline-block">
                                        {% icon "skip_back_10" css_class=ICON_CSS %}
                                    </button>

                                    <button title="Skip forward 10 seconds"
                                        @click="skipForward"
                                        class="{{ BUTTON_CSS }} player--interactive inline-block">
                                        {% icon "skip_forward_10" css_class=ICON_CSS %}
                                    </button>

                                </div>

                                <div class="flex items-center space-x-2 lg:space-x-3">

                                    <div class="flex items-center space-x-1 lg:space-x-2">

                                        <button title="Skip back 10 seconds"
                                            @click="skipBack"
                                            class="{{ BUTTON_CSS }} player--interactive hidden sm:inline-block">
                                            {% icon "skip_back_10" css_class=ICON_CSS %}
                                        </button>

                                        <button title="Skip forward 10 seconds"
                                            @click="skipForward"
                                            class="{{ BUTTON_CSS }} player--interactive hidden sm:inline-block">
                                            {% icon "skip_forward_10" css_class=ICON_CSS %}
                                        </button>

                                    </div>

                                    <div class="flex items-center space-x-2 mr-2 lg:mr-3">
                                        <button class="{{ BUTTON_CSS }} player--interactive inline-block"
                                            @click="decrementPlaybackRate"
                                            title="Decrease Playback Rate">-</button>
                                        <div class="mr-1 md:mr-2 tracking-tight player--interactive"
                                            title="Playback Rate">
                                            x<span x-text="playbackRate.toFixed(1)"></span>
                                        </div>

                                        <button class="{{ BUTTON_CSS }} player--interactive inline-block"
                                            @click="incrementPlaybackRate"
                                            title="Increase Playback Rate">+</button>
                                    </div>
                                    <div class="flex items-center">
                                        <button title="Reload Player"
                                            class="{{ BUTTON_CSS }} inline-block"
                                            accesskey="r"
                                            hx-get="{% url 'episodes:reload_player' %}"
                                            hx-target="#player"
                                            hx-swap="innerHTML">
                                            {% icon "refresh" css_class=ICON_CSS %}
                                        </button>
                                    </div>

                                </div>

                                </div>

                            {% endwith %}
                            <div class="w-full h-3">
                                <input type="range"
                                    x-ref="range"
                                    x-model="currentTime"
                                    :max="duration"
                                    :disabled="isPaused || !isLoaded"
                                    @change="skip"
                                    min="0"
                                    class="h-2 mx-auto rounded-full w-full flex items-center player--interactive player--progress focus:outline-none">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    {% endwith %}
{% endif %}
{% if episode and player_action %}
    {% include "episodes/_player_action.html" with hx_oob=True %}
    {% include "episodes/_history_actions.html" with hx_oob=True %}
{% endif %}
<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('player', () =>  {
            autoplay: {{ player_action|yesno:'true,false' }},
            mediaSrc: '{{ episode.media_url }}',
            currentTime: {% if completed %}0{% else %}{{ current_time|default:0 }}{% endif %},
            duration: 0,
            isError: false,
            isLoaded: false,
            isPaused: false,
            isPlaying: false,
            playbackRate: 1.0,
            defaultPlaybackRate: 1.0,
            lastTimeUpdate: null,
            counters: {
                current: '00:00:00',
                duration: '00:00:00',
            },
            formatDuration(value) {
                if (isNaN(value) || value < 0) return '00:00:00';
                const duration = Math.floor(value);
                const hours = Math.floor(duration / 3600);
                const minutes = Math.floor((duration % 3600) / 60);
                const seconds = Math.floor(duration % 60);
                return [hours, minutes, seconds]
                    .map((t) => t.toString().padStart(2, '0'))
                    .join(':');
            },
            getMediaMetadata() {
                const dataTag = document.getElementById('player-metadata');
                if (!dataTag) {
                    return null;
                }

                const metadata = JSON.parse(dataTag.textContent);

                if (metadata && Object.keys(metadata).length > 0) {
                    return new window.MediaMetadata(metadata);
                }
                return null;
            },
            shortcuts(event) {
                if (event.target.tagName.match(/INPUT|TEXTAREA/)) {
                    return;
                }

                if (!event.ctrlKey && !event.altKey) {
                    switch (event.code) {
                        case 'Space':
                            event.preventDefault();
                            event.stopPropagation();
                            this.togglePlayPause();
                            return;
                        case 'ArrowRight':
                            event.preventDefault();
                            event.stopPropagation();
                            this.skipForward();
                            return;
                        case 'ArrowLeft':
                            event.preventDefault();
                            event.stopPropagation();
                            this.skipBack();
                            return;
                    }
                }

                // playback rate
                if (event.altKey) {
                    switch (event.key) {
                        case '+':
                            event.preventDefault();
                            event.stopPropagation();
                            this.incrementPlaybackRate();
                            return;
                        case '-':
                            event.preventDefault();
                            event.stopPropagation();
                            this.decrementPlaybackRate();
                            return;
                        case '0':
                            event.preventDefault();
                            event.stopPropagation();
                            this.resetPlaybackRate();
                            return;
                    }
                }
            },
            loaded() {
                if (this.isLoaded) {
                    return;
                }

                this.isError = false;

                const stored = this.restore();

                this.playbackRate = stored.playbackRate || this.defaultPlaybackRate;
                this.autoplay = this.autoplay || stored.autoplay;

                if (this.autoplay) {
                    this.$refs.audio.play().catch((err) => {
                        this.isPaused = true;
                        this.isPlaying = false;
                        this.isError = true;
                    });
                } else {
                    this.isPaused = true;
                    this.isPlaying = false;
                }

                this.duration = this.$refs.audio.duration;
                this.isLoaded = true;
            },
            error() {
                this.isPlaying = false;
                this.isError = true;
            },
            timeUpdate() {
                this.isPlaying = true;
                if (this.$refs.audio) {
                    this.currentTime = Math.floor(this.$refs.audio.currentTime);
                    const time = Math.round(this.currentTime);
                    if (time % 5 === 0 && this.lastTimeUpdate !== time) {
                        this.lastTimeUpdate = time;
                        fetch('{% url "episodes:player_time_update" %}', {
                            method: 'POST',
                            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                            body: new URLSearchParams({ current_time: time }),
                        });
                    }
                }
            },
            buffering() {
                this.isPlaying = false;
            },
            resumed() {
                this.isPaused = false;
                this.isPlaying = true;
                this.isError = false;
                this.store();
            },
            paused() {
                this.isPlaying = false;
                this.isPaused = true;
                this.store();
            },
            incrementPlaybackRate() {
                this.changePlaybackRate(0.1);
            },
            decrementPlaybackRate() {
                this.changePlaybackRate(-0.1);
            },
            resetPlaybackRate() {
                this.setPlaybackRate(this.defaultPlaybackRate);
            },
            changePlaybackRate(increment) {
                const newValue = Math.max(
                    0.5,
                    Math.min(2.0, parseFloat(this.playbackRate) + increment)
                );
                this.setPlaybackRate(newValue);
            },
            setPlaybackRate(value) {
                this.playbackRate = value;
                this.store();
            },
            restore() {
                const stored = sessionStorage.getItem('player');
                return stored ? JSON.parse(stored) : {
                    playbackRate: this.defaultPlaybackRate,
                    autoplay: false
                };
            },
            store() {
                sessionStorage.setItem('player', JSON.stringify({
                    playbackRate: this.playbackRate,
                    autoplay: this.isPlaying
                }));
            },
            skip() {
                if (!this.isPaused) {
                    this.$refs.audio.currentTime = this.currentTime;
                }
            },
            skipBack() {
                if (!this.isPaused) {
                    this.$refs.audio.currentTime -= 10;
                }
            },
            skipForward() {
                if (!this.isPaused) {
                    this.$refs.audio.currentTime += 10;
                }
            },
            ended() {
                this.$refs.complete.click();
            },
            togglePlayPause() {
                if (this.isPaused) {
                    this.$refs.audio.play();
                } else {
                    this.$refs.audio.pause();
                }
            },
            init() {
                $watch('currentTime', (value) => {
                    counters.current = formatDuration(value);
                });

                $watch('duration', (value) => {
                    counters.duration = formatDuration(value);
                });

                $watch('playbackRate', (value) => {
                    $refs.audio.playbackRate = value;
                });

                counters.current = formatDuration(currentTime);
                counters.duration = formatDuration(duration);

                $refs.audio.currentTime = currentTime;
                $refs.audio.load();

                if ('mediaSession' in navigator) {
                    navigator.mediaSession.metadata = getMediaMetadata();
                }

            }
        }
            </script>


