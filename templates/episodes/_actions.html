<div class="absolute left-0 bg-white dark:bg-gray-800 w-56 border shadow-xl rounded-lg z-20"
     :class="{'top-0': position === 'dropdown', 'bottom-0': position === 'dropup'}"
     x-data="{show: true, position: 'dropdown'}"
     x-show="show"
     @click.away="show=false"
     @keydown.escape.window="show=false"
     x-init="() => {
        const rect = $el.getBoundingClientRect();
        const vh = document.documentElement.clientHeight;
        position = (vh - rect.top - rect.height) > 0 ? 'dropdown' : 'dropup';
    }">
  <template x-if="show">
    <div class="text-sm">

      {% if is_playing %}
      <button class="w-full hover:bg-gray-300 flex items-center px-4 py-2 border-b"
              hx-post="{% url 'episodes:close_player' %}"
              hx-target="#player"
              hx-swap="outerHTML"
              @click="show=false">
        {% icon "stop" css_class="h-4 w-4 mr-2" %}
        Close Player
      </button>
      {% else %}
      <button class="w-full hover:bg-gray-300 flex items-center px-4 py-2 border-b"
              hx-post="{% url 'episodes:start_player' episode.id %}"
              hx-target="#player"
              hx-swap="outerHTML"
              @click="show=false">
        {% icon "play" css_class="h-4 w-4 mr-2" %}
        Play Episode
      </button>
      {% endif %}

      {% if is_queued %}
      <button class="w-full hover:bg-gray-300 flex items-center px-4 py-2 border-b"
              hx-post="{% url 'episodes:remove_from_queue' episode.id %}"
              @reload-queue.window="show=false">
        {% icon "trash" css_class="h-4 w-4 mr-2" %}
        Remove from Play Queue
      </button>
      {% else %}
      <button class="w-full hover:bg-gray-300 flex items-center px-4 py-2 border-b"
              hx-post="{% url 'episodes:add_to_queue' episode.id %}"
              @click="show=false">
        {% icon "collection" css_class="h-4 w-4 mr-2" %}
        Add to Play Queue
      </button>
      {% endif %}

      {% if is_favorited %}
      <button class="w-full hover:bg-gray-300 flex items-center px-4 py-2 border-b"
              hx-post="{% url 'episodes:remove_favorite' episode.id %}"
              @reload-favorites.window="show=false">
        {% icon "trash" css_class="h-4 w-4 mr-2" %}
        Remove from Favorites
      </button>
      {% else %}
      <button class="w-full hover:bg-gray-300 flex items-center px-4 py-2 border-b"
              hx-post="{% url 'episodes:add_favorite' episode.id %}"
              @click="show=false">
        {% icon "star" css_class="h-4 w-4 mr-2" %}
        Add to Favorites
      </button>
      {% endif %}

      {% if episode.listened and not is_playing %}
      <button class="w-full hover:bg-gray-300 flex items-center px-4 py-2 border-b"
              hx-post="{% url 'episodes:remove_audio_log' episode.id %}"
              @reload-history.window="show=false">
        {% icon "trash" css_class="h-4 w-4 mr-2" %}
        Remove from History
      </button>
      {% endif %}

      <a class="w-full hover:bg-gray-300 flex items-center px-4 py-2 border-b"
         title="Download episode"
         href="{{ episode.media_url }}">
        <div class="mr-2">
          {% icon "download" css_class="h-4 w-4" %}
        </div>
        Download
      </a>
      <button class="w-full hover:bg-gray-300 flex items-center px-4 py-2 border-b"
              @click="show=false">
        {% icon "x" css_class="h-4 w-4 mr-2" %}
        Close
      </button>
    </div>
  </template>
</div>
