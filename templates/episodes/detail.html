{% extends "base.html" %}
{% load i18n %}
{% block title %}
    | {{ episode.podcast.cleaned_title }} | {{ episode.cleaned_title }}
{% endblock title %}
{% block content %}
    {% with podcast=episode.podcast next_episode=episode.get_next_episode previous_episode=episode.get_previous_episode %}
        <header class="mb-3 border-b dark:border-gray-500 pb-3 space-y-6">
            <h1 class="font-bold text-lg lg:text-xl xl:text-2xl">{{ episode.cleaned_title }}</h1>
            {% if next_episode or previous_episode %}
                {% translate "Next" as t_next %}
                {% translate "Previous" as t_previous %}
                {% translate "No More Episodes" as t_no_more_episodes %}
                <nav>
                    <ul class="flex justify-between"
                        role="navigation"
                        aria-label="{% translate "Pagination" %}">
                        <li>
                            {% if previous_episode %}
                                <a class="link"
                                    href="{{ previous_episode.get_absolute_url }}"
                                    aria-label="{{ previous_episode.cleaned_title }}"
                                    title="{{ previous_episode.cleaned_title }}">
                                    {{ t_previous }}
                                </a>
                            {% else %}
                                <span class="text-gray-600 dark:text-gray-300 cursor-not-allowed"
                                    title="{{ t_no_more_episodes }}"
                                    aria-label="{{ t_no_more_episodes }}">{{ t_previous }}</span>
                            {% endif %}
                        </li>
                        <li>
                            {% if next_episode %}
                                <a class="link"
                                    href="{{ next_episode.get_absolute_url }}"
                                    aria-label="{{ next_episode.cleaned_title }}"
                                    title="{{ next_episode.cleaned_title }}">
                                    {{ t_next }}
                                </a>
                            {% else %}
                                <span class="text-gray-600 dark:text-gray-300 cursor-not-allowed"
                                    title="{{ t_no_more_episodes }}"
                                    aria-label="{{ t_no_more_episodes }}">{{ t_next }}</span>
                            {% endif %}
                        </li>
                    </ul>
                </nav>
            {% endif %}
        </header>
        <article class="space-y-3">
            <h2 class="text-base lg:text-lg">
                <a href="{{ podcast.get_episodes_url }}"
                    title="{% blocktranslate with podcast=podcast.cleaned_title %}See all episodes for {{ podcast }}{% endblocktranslate %}"
                    class="link">
                    {{ podcast.cleaned_title }}
                </a>
            </h2>
            {% with metadata=episode.get_episode_metadata %}
                {% if metadata %}
                    <div class="flex items-center space-x-3 font-semibold text-gray-800 dark:text-gray-300">{{ metadata }}</div>
                {% endif %}
            {% endwith %}
            <div class="flex items-center space-x-3 sm:space-x-6">
                {% include "includes/cover_image.html" with cover_url=episode.get_cover_url alt=podcast.cleaned_title url=podcast.get_absolute_url css_class="h-32 w-32 lg:h-40 lg:w-40" %}
                <div class="flex flex-col place-content-between h-28 lg:h-32">
                    {% block audio_player %}
                        {% with target=episode.get_player_target %}
                            <div hx-push-url="false"
                                hx-target="this"
                                hx-disinherit="hx-indicator"
                                hx-swap="multi:#{{ target }}:outerHTML,#{{ episode.get_history_target }}:outerHTML,#audio-player:outerHTML"
                                id="{{ target }}">
                                {% if is_playing %}
                                    <button class="inline-flex items-center btn btn-primary btn-outline btn-lg"
                                        hx-post="{% url 'episodes:close_player' %}"
                                        title="{% translate "Close Player" %}">
                                        {% icon "stop-circle" "regular" css_class="mr-2" %}
                                        {% translate "Close" %}
                                    </button>
                                {% else %}
                                    <button class="inline-flex items-center btn btn-primary btn-lg"
                                        hx-post="{% url 'episodes:start_player' episode.id %}"
                                        title="{% translate "Open Episode in Player" %}">
                                        {% icon "play-circle" "regular" css_class="mr-2" %}
                                        {% translate "Play" %}
                                    </button>
                                {% endif %}
                            </div>
                            {% if request.htmx.target == target %}
                                {% include "episodes/includes/audio_player.html" %}
                            {% endif %}
                        {% endwith %}
                    {% endblock audio_player %}
                    {% block bookmark %}
                        {% with target=episode.get_bookmark_target %}
                            <div class="flex items-center"
                                id="{{ target }}"
                                hx-push-url="false"
                                hx-target="this"
                                hx-swap="multi:#{{ target }}:outerHTML,#messages:outerHTML"
                                hx-disinherit="hx-indicator">
                                {% if is_bookmarked %}
                                    {% translate "Remove from Bookmarks" as t_remove_bookmark %}
                                    <button title="{{ t_remove_bookmark }}"
                                        class="inline-flex items-center btn btn-default btn-outline"
                                        hx-post="{% url 'episodes:remove_bookmark' episode.id %}">
                                        {% icon "star" css_class="mr-2" %}
                                        {% translate "Bookmark" %}
                                    </button>
                                {% else %}
                                    {% translate "Add to Bookmarks" as t_add_bookmark %}
                                    <button title="{{ t_add_bookmark }}"
                                        class="inline-flex items-center btn btn-default"
                                        hx-post="{% url 'episodes:add_bookmark' episode.id %}">
                                        {% icon "star" "regular" css_class="mr-2" %}
                                        {% translate "Bookmark" %}
                                    </button>
                                {% endif %}
                            </div>
                            {% if request.htmx.target == target %}
                                {% include "includes/messages.html" %}
                            {% endif %}
                        {% endwith %}
                    {% endblock bookmark %}
                    <div class="flex items-center flex-wrap font-semibold text-gray-800 dark:text-gray-300 space-x-2 sm:space-x-3">
                        <a download
                            title="{% translate "Download audio file to your device" %}"
                            href="{{ episode.media_url }}"
                            class="link">
                            {% translate "Download" %}
                        </a>
                        {% with link=episode.get_link %}
                            {% if link %}
                                <a href="{{ link }}"
                                    target="_blank"
                                    rel="noopener"
                                    class="link"
                                    title="{% translate "Link to Website" %}">
                                    {% translate "Website" %}
                                </a>
                            {% endif %}
                        {% endwith %}
                    </div>
                </div>
            </div>
            <div class="flex items-center font-semibold text-gray-600 dark:text-gray-300 space-x-3">
                {% include "includes/date.html" with value=episode.pub_date title=_("Release Date") %}
                {% with file_size=episode.get_file_size %}
                    {% if file_size %}<div title="Size">{{ file_size }}</div>{% endif %}
                {% endwith %}
                {% with duration=episode.duration_in_seconds %}
                    {% if duration %}
                        <span title="{% translate "Duration" %}">{{ duration|format_duration }}</span>
                    {% endif %}
                {% endwith %}
                {% with explicit=episode.is_explicit %}
                    {% if explicit %}
                        <div title="{% translate "May contain adult themes and language. Listener discretion advised." %}"
                            class="flex items-center text-red-600 dark:text-red-500 space-x-2">
                            {% icon "warning" %} <span class="inline-block">{% translate "Explicit" %}</span>
                        </div>
                    {% endif %}
                {% endwith %}
            </div>
            {% with listened=episode.listened current_time=episode.current_time %}
                {% block history %}
                    {% with target=episode.get_history_target %}
                        <div id="{{ target }}">
                            {% if listened %}
                                <div class="space-x-3 flex items-center flex-wrap font-semibold text-gray-600 dark:text-gray-300">
                                    <div class="flex items-center space-x-1">
                                        {% translate "Listened" as t_listened %}
                                        <span>{{ t_listened }}</span>
                                        {% include "includes/date.html" with value=listened title=t_listened %}
                                    </div>
                                    {% with duration=episode.duration_in_seconds current_time=current_time|default:0 %}
                                        {% if duration and current_time and current_time > 60 and current_time < duration %}
                                            <div title="{% translate "Timestamp" %}">{{ current_time|format_duration }}</div>
                                        {% endif %}
                                    {% endwith %}
                                    {% if not is_playing %}
                                        <button class="inline-flex items-center btn btn-danger text-xs lg:text-sm"
                                            title="{% translate "Remove episode from your History" %}"
                                            hx-post="{% url 'episodes:remove_audio_log' episode.id %}"
                                            hx-disinherit="hx-indicator"
                                            hx-push-url="false"
                                            hx-target="#{{ target }}"
                                            hx-swap="multi:#{{ target }}:outerHTML,#messages:outerHTML"
                                            hx-confirm="{% translate "Are you sure you want to remove this episode from your History?" %}">
                                            {% icon "trash" css_class="mr-2" %}
                                            {% translate "Remove" %}
                                        </button>
                                    {% endif %}
                                </div>
                            {% endif %}
                            {% if request.htmx.target == target %}
                                {% include "includes/messages.html" %}
                            {% endif %}
                        </div>
                    {% endwith %}
                {% endblock history %}
            {% endwith %}
            {% markdown episode.description %}
        </article>
    {% endwith %}
{% endblock content %}
