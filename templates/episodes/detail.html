{% extends "base.html" %}
{% load i18n %}

{% block title %} | {{ episode.podcast.cleaned_title }} | {{ episode.cleaned_title }}{% endblock %}
{% block content_metadata %}
    {% with podcast=episode.podcast %}
        {% with episode_title=episode.cleaned_title|escapejs episode_description=episode.cleaned_description|default:podcast.cleaned_description|truncatechars:200|escapejs cover_url=episode.get_cover_url %}
            {% if episode_description %}
                <meta name="description"
                    content="{{ episode_description }}" />
            {% endif %}
            {% if podcast.keywords %}
                <meta name="keywords"
                    content="{{ podcast.keywords|escapejs }}" />
            {% endif %}

            <meta name="og:type"
                content="website" />
            <meta name="og:title"
                content="{{ episode_title }}" />
            {% if episode_description %}
                <meta name="og:description"
                    content="{{ episode_description }}" />
            {% endif %}
            <meta name="og:url"
                content="{% absolute_uri episode %}" />

            {% if cover_url %}
                <meta name="og:image"
                    content="{{ cover_url }}" />
                <meta name="og:image:alt"
                    content="{{ episode_title }}" />
                <meta name="og:image:height"
                    content="200" />
                <meta name="og:image:width"
                    content="200" />
            {% endif %}

            <meta name="twitter:card"
                content="{{ cover_url|yesno:'summary_large_image,summary' }}">

            {% if cover_url %}
                <meta name="twitter:image"
                    content="{{ cover_url }}">
            {% endif %}

            <meta name="twitter:title"
                content="{{ episode_title }}">
            {% if episode_description %}
                <meta name="twitter:description"
                    content="{{ episode_description }}">
            {% endif %}
            <script type="application/ld+json">
                {
                    "@context": "https://schema.org",
                    "@type": "NewsArticle",
                    "mainEntityOfPage": {
                        "@type": "WebPage",
                        "@id": "{% absolute_uri podcast %}"
                    },
                    "url": "{% absolute_uri episode %}",
                    "headline": "{{ episode_title }}",
                    "description": "{{ episode_description }}",
                    {% if cover_url %}
                        "image": [
                            "{{ cover_url }}"
                        ],
                    {% endif %}
                    {% if podcast.owner %}
                        "publisher": {
                            "@type": "Organization",
                            "name": "{{ podcast.owner|escapejs }}"
                        }
                    {% endif %}
                }
            </script>

        {% endwith %}
    {% endwith %}
{% endblock content_metadata %}

{% block content %}
    <h1 class="font-bold mb-6 text-lg md:text-xl xl:text-2xl">{{ episode.cleaned_title }}</h1>

    {% with podcast=episode.podcast %}

        <nav class="flex justify-between mb-3 border-b dark:border-gray-500 pb-3"
            role="navigation"
            aria-label="{% translate "Pagination" %}">
            {% if previous_episode %}
                <a class="link"
                    href="{{ previous_episode.get_absolute_url }}"
                    aria-label="{{ previous_episode.cleaned_title }}"
                    title="{{ previous_episode.cleaned_title }}">
                    {% translate "Previous" %}
                </a>

            {% else %}
                <span class="text-gray-600 dark:text-gray-300 cursor-not-allowed"
                    title="No more episodes"
                    aria-label="{% translate "No more episodes" %}">{% translate "Previous" %}</span>
            {% endif %}
            {% if next_episode %}
                <a class="link"
                    href="{{ next_episode.get_absolute_url }}"
                    aria-label="{{ next_episode.cleaned_title }}"
                    title="{{ next_episode.cleaned_title }}">
                    {% translate "Next" %}
                </a>
            {% else %}
                <span class="text-gray-600 dark:text-gray-300 cursor-not-allowed"
                    title="No more episodes"
                    aria-label="{% translate "No more episodes" %}">{% translate "Next" %}</span>
            {% endif %}
        </nav>

        <article class="space-y-3">
            <h2 class="md:text-lg">
                <a href="{{ podcast.get_episodes_url }}"
                    title="{% blocktranslate with podcast=podcast.cleaned_title %}See All Episodes for {{ podcast }}{% endblocktranslate %}"
                    class="link">
                    {{ podcast.cleaned_title }}
                </a>
            </h2>

            {% with metadata=episode.get_episode_metadata %}
                {% if metadata %}
                    <div class="font-semibold text-gray-800 dark:text-gray-300 flex items-center space-x-3">
                        {{ metadata }}
                    </div>
                {% endif %}
            {% endwith %}

            <div class="flex items-center space-x-3 sm:space-x-6">

                {% with COVER_IMAGE_CSS="h-28 w-28 md:h-36 md:w-36" %}
                    <div class="{{ COVER_IMAGE_CSS}}">
                        {% include "includes/cover_image.html" with cover_url=episode.get_cover_url alt=podcast.cleaned_title size=36 css_class=COVER_IMAGE_CSS|add:" border dark:border-gray-500" url=podcast.get_absolute_url %}
                    </div>
                {% endwith %}


                <div class="flex flex-col place-content-between h-24 md:h-28">

                    {% include "episodes/actions/player.html" %}

                    <div class="flex items-center space-x-3 md:space-x-4">
                        <a download
                            title="Download {{ episode.get_media_url_ext|upper }} File"
                            href="{{ episode.media_url }}"
                            class="link">
                            {% if user.is_anonymous %}
                                {% translate "Download" %}
                            {% else %}
                                {% include "icons/download.svg" with css_class="h-5 w-5 md:h-6 md:w-6" %}
                            {% endif %}
                        </a>

                        {% if user.is_authenticated %}
                            {% include "episodes/actions/bookmark.html" %}
                            {% include "episodes/actions/history.html" with listened=episode.listened %}
                        {% endif %}
                    </div>

                    {% share_buttons episode.get_absolute_url podcast.cleaned_title|add:" | "|add:episode.cleaned_title %}

                </div>
            </div>

            {% include "episodes/includes/timestamps.html" with current_time=episode.current_time listened=episode.listened %}

            {% with file_size=episode.get_file_size explicit=episode.is_explicit link=episode.get_link %}
                {% if file_size or link or explicit %}
                    <div class="flex items-center flex-wrap font-semibold text-gray-800 dark:text-gray-300 space-x-2 sm:space-x-3">

                        {% if explicit %}
                            <div title="{% translate "May contain adult themes and language. Listener discretion advised." %}"
                                class="text-red-600 dark:text-red-500 flex items-center">
                                {% include "icons/warning.svg" with css_class="h-5 w-5 mr-1" %}
                                <span class="inline-block">{% translate "Explicit" %}</span>
                            </div>
                        {% endif %}

                        {% if file_size %}
                            <div title="Size">
                                {{ file_size }}
                            </div>
                        {% endif %}

                        {% if link %}
                            <a href="{{ link }}"
                                target="_blank"
                                rel="noopener"
                                class="link">
                                {% translate "Website" %}
                            </a>
                        {% endif %}

                    </div>
                {% endif %}
            {% endwith %}

            {% markdown episode.description %}

        </article>
    {% endwith %}
{% endblock %}
