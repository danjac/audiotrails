{% if user.is_authenticated %}
{% load player %}
<div id="player"
     x-data="Player()"
     x-init="initialize()"
     hx-preserve="true"
     @keydown.window="shortcuts($event)"
     @close-player.window="closePlayer()"
     @play-episode.window="playEpisode($event)">
  <audio x-ref="audio"
         preload="metadata"
         :src="episode ? episode.mediaUrl : null"
         @play="resumed()"
         @pause="paused()"
         @error="waiting()"
         @suspend="waiting()"
         @stalled="waiting()"
         @canplaythrough="active()"
         @canplay="active()"
         @playing="active()"
         @loadedmetadata="loaded()"
         @ended="ended()"
         @timeupdate="timeUpdate()">
  </audio>

  <template x-if="episode">
    <div class="fixed bottom-0 z-10 bg-black dark:bg-gray-800 text-white w-full px-2 py-1 font-semibold"
         id="player-controls"
         :class="{'player--active': isPlaying, 'player--inactive': !isPlaying}">
      <div class="relative space-y-1">

        <div class="sm:hidden pr-1 text-sm w-84 text-center truncate">
          <a :href="episode.url"
             @click.prevent="htmx.ajax('GET', episode.url)"
             hx-disable
             class="player--title"
             :title="episode.title"
             x-text="episode.title"></a>
        </div>

        <div class="flex items-center space-x-2 sm:space-x-1">

          <div>
            <a :href="podcast.url"
               @click.prevent="htmx.ajax('GET', podcast.url)"
               hx-disable="true">
              <img class="object-cover border dark:border-gray-500 bg-transparent h-14 w-14 lg:h-18 lg:w-18 mr-2 self-center hover:opacity-75 border-white cursor-pointer"
                   title="podcast.title"
                   alt="podcast.title"
                   :width="podcast.coverImage.width"
                   :height="podcast.coverImage.height"
                   :src="podcast.coverImage.url">
            </a>
          </div>
          <div class="w-full space-y-1">

            <div class="flex justify-between items-center w-full">

              <div class="flex items-center">

                <button title="Pause"
                        @click="$refs.audio.pause()"
                        x-show="isPlaying"
                        class="focus:outline-none hover:text-blue-500 mr-1">
                  {% icon "pause" css_class="h-8 w-8" %}
                </button>

                <button title="Play"
                        @click="$refs.audio.play()"
                        x-show="isPaused"
                        class="focus:outline-none hover:text-blue-600 mr-1">
                  {% icon "play" css_class="h-8 w-8" %}
                </button>

                <button title="Stop"
                        @click="$dispatch('close-player')"
                        class="focus:outline-none hover:text-blue-500 mr-1">
                  {% icon "stop" css_class="h-8 w-8" %}
                </button>

              </div>

              <div class="hidden sm:block text-sm text-center sm:w-64 w-96 lg:w-full truncate">
                <a :href="episode.url"
                   class="player--title"
                   hx-disable
                   @click.prevent="htmx.ajax('GET', episode.url)"
                   title="episode.title"
                   x-text="episode.title"></a>
              </div>

              <div class="flex items-center">
                <button class="focus:outline-none mr-1 md:mr-2 p-1 hover:text-blue-500 player--interactive"
                        @click="decrementPlaybackRate"
                        title="Decrease Playback Rate">-</button>
                <div class="mr-1 md:mr-2 tracking-tight leading-tight player--interactive text-sm"
                     title="Playback Rate">
                  x<span x-text="playbackRate.toFixed(1)"></span>
                </div>
                <button class="focus:outline-none p-1 hover:text-blue-500 mr-3 player--interactive"
                        @click="incrementPlaybackRate"
                        title="Increase Playback Rate">+</button>

                <button title="Skip back 10 seconds"
                        @click="skipBack"
                        class="focus:outline-none hover:text-blue-500 player--interactive mr-2">
                  {% icon "skip_back_10" css_class="h-6 w-6" %}
                </button>
                <button title="Skip forward 10 seconds"
                        @click="skipForward"
                        class="player--interactive focus:outline-none hover:text-blue-500 player--interactive">
                  {% icon "skip_forward_10" css_class="h-6 w-6" %}
                </button>
              </div>

            </div>

            <div class="flex items-center w-full mx-1">
              <div class="h-2 mx-auto rounded-full w-full flex items-center player--interactive player--progress"
                   x-ref="progressBar"
                   @click="skip($event)">
                <div class="w-4 h-4 rounded-full absolute border shadow-xl player--indicator"
                     x-ref="indicator"
                     style="z-index: 12;"></div>
              </div>
              <div class="w-20 mr-2 text-right tracking-tighter text-sm md:text-base player--counter">
                -<span x-text="counter"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </template>
</div>

{% get_player_info as player_info %}
{% if player_info %}
{{ player_info|json_script:"player-info" }}
{% endif %}
{% endif %}
