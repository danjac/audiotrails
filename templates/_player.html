{% load player %}
<div id="player"
     x-data="Player()"
     x-init="initialize()"
     hx-preserve="true"
     @keydown.window="shortcuts($event)"
     @close-player.window="closePlayer()"
     @play-episode.window="playEpisode($event)">
  <script>
    const Player = () => {

      const defaults = {
        episode: null,
        podcast: null,
        currentTime: 0,
        duration: 0,
        audio: null,
        isPlaying: false,
        isPaused: false,
        isWaiting: false,
        playbackRate: 1.0,
        counter: '00:00:00',
      };

      let timer;

      const instance = {
        ...defaults,
        initialize() {
          if (this.episode) {
            this.startPlayer(this.episode.mediaUrl);
          }
          this.$watch('duration', (value) => {
            this.updateProgressBar(value, this.currentTime);
          });
          this.$watch('currentTime', (value) => {
            this.updateProgressBar(this.duration, value);
          });
        },
        playEpisode($event) {
          const {
            url
          } = $event.detail;
          sendJSON(url)
            .then((response) => response.json())
            .then((data) => {
              this.openPlayer(data);
            });
        },
        openPlayer(data) {
          this.stopPlayer();

          if (data) {
            const {
              episode,
              podcast,
              currentTime,
              metadata
            } = data;

            this.episode = episode;
            this.podcast = podcast;
            this.currentTime = currentTime;

            if (metadata && 'mediaSession' in navigator) {
              if (Object.keys(metadata).length > 0) {
                navigator.mediaSession.metadata = new window.MediaMetadata(metadata);
              } else {
                navigator.mediaSession.metadata = null;
              }
            }
            dispatch(this.$el, 'open-player', data);
            dispatch(this.$el, 'remove-queue-item', {
              id: this.episode.id
            });

            this.startPlayer(this.episode.mediaUrl);
          }
        },
        closePlayer() {
          sendJSON("{% url 'episodes:close_player' %}");
          this.episode = null;
          this.podcast = null;
          this.currentTime = 0;
          this.stopPlayer();
        },
        // audio events
        loaded() {
          if (this.audio) {
            this.duration = this.audio.duration;
          }
        },
        timeUpdate() {
          if (this.audio) {
            this.currentTime = this.audio.currentTime;
          }
        },
        resumed() {
          this.isPlaying = true;
          this.isPaused = false;
          this.isWaiting = false;
        },
        paused() {
          this.isPlaying = false;
          this.isPaused = true;
          this.isWaiting = false;
        },
        waiting() {
          this.isWaiting = true;
        },
        active() {
          this.isWaiting = false;
        },
        ended() {
          sendJSON("{% url 'episodes:play_next_episode' %}")
            .then((response) => response.json())
            .then((data) => {
              if (Object.keys(data).length === 0) {
                dispatch(this.$el, 'close-player');
              } else {
                this.openPlayer(data);
              }
            });
        },
        shortcuts(event) {
          // ignore if inside an input element
          if (!this.audio) {
            return;
          }

          if (/^(INPUT|SELECT|TEXTAREA)$/.test(event.target.tagName)) {
            return;
          }

          const handlers = {
            '+': this.incrementPlaybackRate,
            '-': this.decrementPlaybackRate,
            ArrowLeft: this.skipBack,
            ArrowRight: this.skipForward,
            Space: this.togglePause,
            //Delete: this.closePlayer,
          };

          const handler = handlers[event.code] || handlers[event.key];

          if (handler) {
            event.preventDefault();
            handler.bind(this)();
          }
        },

        incrementPlaybackRate() {
          this.changePlaybackRate(0.1);
        },
        decrementPlaybackRate() {
          this.changePlaybackRate(-0.1);
        },

        changePlaybackRate(increment) {
          const value = parseFloat(this.playbackRate);
          let newValue = value + increment;
          if (newValue > 2.0) {
            newValue = 2.0;
          } else if (newValue < 0.5) {
            newValue = 0.5;
          }
          this.audio.playbackRate = this.playbackRate = newValue;
        },

        skip({
          clientX
        }) {
          // user clicks on progress bar
          const position = this.getProgressBarPosition(clientX);
          if (!isNaN(position) && position > -1) {
            this.skipTo(position);
          }
        },

        skipBack() {
          this.skipTo(this.audio.currentTime - 10);
        },

        skipForward() {
          this.skipTo(this.audio.currentTime + 10);
        },

        skipTo(position) {
          if (!isNaN(position) && !this.isPaused) {
            this.audio.currentTime = position;
          }
        },

        togglePause() {
          if (this.isPaused) {
            this.audio.play();
          } else {
            this.audio.pause();
          }
        },
        startPlayer(mediaUrl) {
          this.audio = new Audio(mediaUrl);
          this.audio.currentTime = this.currentTime;
          this.configAudioListeners(false);
          this.audio.play().catch((e) => {
            console.log(e);
            this.isPaused = true;
          });
          timer = setInterval(this.sendCurrentTimeUpdate.bind(this), 5000);
        },
        stopPlayer() {
          if (this.audio) {
            this.audio.pause();
            this.configAudioListeners(true);
            this.audio = null;
          }
          if (timer) {
            clearInterval(timer);
          }
        },
        sendCurrentTimeUpdate() {
          if (this.audio && !this.isPaused && !this.isWaiting && this.currentTime) {
            sendJSON("{% url 'episodes:player_update_current_time' %}", {
              currentTime: this.currentTime,
            });
          }
        },
        configAudioListeners(remove) {
          const events = {
            play: this.resumed,
            pause: this.paused,
            error: this.waiting,
            suspend: this.waiting,
            stalled: this.waiting,
            canplaythrough: this.active,
            canplay: this.active,
            playing: this.active,
            loadedmetadata: this.loaded,
            ended: this.ended,
            timeupdate: this.timeUpdate,
          };
          Object.keys(events).forEach((name) => {
            const event = events[name].bind(this);
            if (remove) {
              this.audio.removeEventListener(name, event);
            } else {
              this.audio.addEventListener(name, event);
            }
          });
        },
        updateProgressBar(duration, currentTime) {
          if (this.audio) {
            this.counter = formatDuration(duration - currentTime);
            const pcComplete = percent(duration, currentTime);
            if (this.$refs.indicator) {
              this.$refs.indicator.style.left =
                this.getIndicatorPosition(pcComplete) + 'px';
            }
          }
        },
        getProgressBarPosition(clientX) {
          if (!isNaN(clientX)) {
            const {
              left
            } = this.$refs.progressBar.getBoundingClientRect();
            const width = this.$refs.progressBar.clientWidth;
            let position = clientX - left;
            return Math.ceil(this.duration * (position / width));
          } else {
            return -1;
          }
        },
        getIndicatorPosition(pcComplete) {
          const clientWidth = this.$refs.progressBar.clientWidth;
          let currentPosition, width;

          currentPosition = this.$refs.progressBar.getBoundingClientRect().left - 24;

          if (clientWidth === 0) {
            width = 0;
          } else {
            // min 1rem to accomodate indicator
            const minWidth = (16 / clientWidth) * 100;
            width = pcComplete > minWidth ? pcComplete : minWidth;
          }
          if (width) {
            currentPosition += clientWidth * (width / 100);
          }
          return currentPosition;
        },
      };

      const playerInfoTag = document.getElementById('player-info');

      if (playerInfoTag) {
        return {
          ...instance,
          ...JSON.parse(playerInfoTag.textContent),
        };
      }

      return instance;
    };

    const formatDuration = (value) => {
      if (isNaN(value) || value < 0) return '00:00:00';
      const duration = Math.floor(value);

      const hours = Math.floor(duration / 3600);
      const minutes = Math.floor((duration % 3600) / 60);
      const seconds = Math.floor(duration % 60);

      return [hours, minutes, seconds].map((t) => t.toString().padStart(2, '0')).join(':');
    };

    const percent = (nominator, denominator) => {
      if (!denominator || !nominator) {
        return 0;
      }

      if (denominator > nominator) {
        return 100;
      }

      return (denominator / nominator) * 100;
    };
  </script>
  <template x-if="episode">
    <div class="fixed bottom-0 z-10 bg-black dark:bg-gray-800 text-white w-full px-2 py-1 font-semibold"
         id="player-controls"
         :class="{'player--active': isPlaying, 'player--inactive': !isPlaying}">
      <div class="relative space-y-1">

        <div class="sm:hidden pr-1 text-sm w-84 text-center truncate">
          <a :href="episode.url"
             @click.prevent="htmx.ajax('GET', episode.url)"
             hx-disable
             class="player--title"
             :title="episode.title"
             x-text="episode.title"></a>
        </div>

        <div class="flex items-center space-x-2 sm:space-x-1">

          <div>
            <a :href="podcast.url"
               @click.prevent="htmx.ajax('GET', podcast.url)"
               hx-disable="true">
              <img class="object-cover border dark:border-gray-500 bg-transparent h-14 w-14 lg:h-18 lg:w-18 mr-2 self-center hover:opacity-75 border-white cursor-pointer"
                   title="podcast.title"
                   alt="podcast.title"
                   :width="podcast.coverImage.width"
                   :height="podcast.coverImage.height"
                   :src="podcast.coverImage.url">
            </a>
          </div>
          <div class="w-full space-y-1">

            <div class="flex justify-between items-center w-full">

              <div class="flex items-center">

                <button title="Pause"
                        @click="audio.pause()"
                        x-show="isPlaying"
                        class="focus:outline-none hover:text-blue-500 mr-1">
                  {% icon "pause" css_class="h-8 w-8" %}
                </button>

                <button title="Play"
                        @click="audio.play()"
                        x-show="isPaused"
                        class="focus:outline-none hover:text-blue-600 mr-1">
                  {% icon "play" css_class="h-8 w-8" %}
                </button>

                <button title="Stop"
                        @click="$dispatch('close-player')"
                        class="focus:outline-none hover:text-blue-500 mr-1">
                  {% icon "stop" css_class="h-8 w-8" %}
                </button>

              </div>

              <div class="hidden sm:block text-sm text-center sm:w-64 w-96 lg:w-full truncate">
                <a :href="episode.url"
                   class="player--title"
                   hx-disable
                   @click.prevent="htmx.ajax('GET', episode.url)"
                   title="episode.title"
                   x-text="episode.title"></a>
              </div>

              <div class="flex items-center">
                <button class="focus:outline-none mr-1 md:mr-2 p-1 hover:text-blue-500 player--interactive"
                        @click="decrementPlaybackRate"
                        title="Decrease Playback Rate">-</button>
                <div class="mr-1 md:mr-2 tracking-tight leading-tight player--interactive text-sm"
                     title="Playback Rate">
                  x<span x-text="playbackRate.toFixed(1)"></span>
                </div>
                <button class="focus:outline-none p-1 hover:text-blue-500 mr-3 player--interactive"
                        @click="incrementPlaybackRate"
                        title="Increase Playback Rate">+</button>

                <button title="Skip back 10 seconds"
                        @click="skipBack"
                        class="focus:outline-none hover:text-blue-500 player--interactive mr-2">
                  {% icon "skip_back_10" css_class="h-6 w-6" %}
                </button>
                <button title="Skip forward 10 seconds"
                        @click="skipForward"
                        class="player--interactive focus:outline-none hover:text-blue-500 player--interactive">
                  {% icon "skip_forward_10" css_class="h-6 w-6" %}
                </button>
              </div>

            </div>

            <div class="flex items-center w-full mx-1">
              <div class="h-2 mx-auto rounded-full w-full flex items-center player--interactive player--progress"
                   x-ref="progressBar"
                   @click="skip($event)">
                <div class="w-4 h-4 rounded-full absolute border shadow-xl player--indicator"
                     x-ref="indicator"
                     style="z-index: 12;"></div>
              </div>
              <div class="w-20 mr-2 text-right tracking-tighter text-sm md:text-base player--counter">
                -<span x-text="counter"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </template>
</div>
{% get_player_info as player_info %}
{% if player_info %}
{{ player_info|json_script:"player-info" }}
{% endif %}
